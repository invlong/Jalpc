# 数据同步方案起草书

### 一.要解决的问题

#### 1.全量数据同步导致服务端压力过大。

#### 2.更加细分的增量数据获取。

拿档案举例，如我想要获取某个版本后的所有的人脸档案的变更，或者卡号的变更。根据具体的业务，实现更加细分的增量数据拉取。

思路：

1.每个学校为一个租户，分为不同的数据同步场景。

比如清华附属中学，同步档案信息。

比如清华附属中学，同步部门信息。

对应的表为sc_version。

学校租户为schoo_id,场景区别为key，人员key值为user，部门key值为dept

程序每次对部门的操作（批量的话也是申请一次），都需要按照学校和场景去申请版本号（version_id），并将返回的版本id，更新到对应业务表的version字段中。

2.使用方法

当某个租户（学校）根据当前最大的版本号，到云端请求之后的增量数据时，根据当前版本号，查询之后版本号的所有记录，返回给租户。

3.如何应对海量数据的请求版本号的请求。

- 内存中储存最近一个分配出去的version：cur_ver，以及分配上限：max_ver

- 分配version时，将cur_ver++，同时与分配上限max_ver比较：如果cur_ver > max_ver，将分配上限提升一个步长max_ver += step，并持久化max_ver

- 重启时，读出持久化的max_ver，赋值给version

