---
layout: post  
title: "Redisä¸­æ ¹æ®å…³é”®è¯æ¨¡ç³ŠåŒ¹é…keyå¹¶æ‰¹é‡åˆ é™¤"  
date: 2021-01-06 11:24:00 +0800  
categories: æŠ€æœ¯æ–‡ç«   
tag: "æ•™ç¨‹"  
---

* content
{:toc}  


> çº¿ä¸ŠRediså­˜åœ¨å¤§é‡ä¸å¸¸ç”¨çš„å†—ä½™çš„å€¼ï¼Œå¯¹æœåŠ¡å™¨çš„å†…å­˜é€ æˆæµªè´¹ï¼Œæ‰€ä»¥ä¼˜åŒ–å­˜å…¥å’Œè¿‡æœŸé€»è¾‘ï¼Œå¹¶æ‰‹åŠ¨æ¸…ç†æ— ç”¨çš„å€¼ã€‚

#### ä¸€.ç™»å½•Redisæ§åˆ¶å°

æˆ‘ä»¬å¯ä»¥ç›´æ¥ç™»å½•åˆ°redisæ§åˆ¶å°ï¼Œä½¿ç”¨åŸå£°çš„å‘½ä»¤æ¥æ‰§è¡Œåˆ é™¤ï¼ˆå¦‚`DEL`ã€`KEYS`ç­‰ï¼‰ï¼Œä½†æ˜¯ä¸æ”¯æŒå¤æ‚çš„ç”¨æ³•ï¼Œä¹Ÿå°±æ˜¯æ— æ³•æ¨¡ç³Šçš„æŸ¥è¯¢keyè¿›è¡Œæ‰¹é‡åˆ é™¤ã€‚

å‚è€ƒï¼š[Rediså®˜æ–¹å‘½ä»¤åœ°å€](https://redis.io/commands/)

#### äºŒ.Rediså®¢æˆ·ç«¯å·¥å…·

Redisæ”¯æŒå¤šç§å®¢æˆ·ç«¯å·¥å…·ï¼Œé™¤äº†å¼€å‘è¯­è¨€å¤–ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„æ˜¯ä¸€æ¬¾åä¸º[RedisCli](https://redis.io/clients)çš„å·¥å…·ï¼Œå®ç°æ ¹æ®keyæ¨¡ç³Šåˆ é™¤çš„è¯­å¥å¦‚ä¸‹ï¼š

```shell
redis-cli -h 127.0.0.1 -p 6379 -a yourpassword keys "keyword*" |xargs redis-cli -h 127.0.0.1 -p 6379 -a youpassword del
```

-hæŒ‡å®šhoståœ°å€ï¼Œé»˜è®¤127.0.0.1

-pæŒ‡å®športï¼Œé»˜è®¤6379

-aæŒ‡å®šrediså¯†ç 

keywordä¸ºæŒ‡å®šçš„keyçš„æ¨¡ç³Šå…³é”®è¯ï¼Œ`*`ä»£è¡¨é€šé…ç¬¦ã€‚

è¿™ä¸ªå‘½ä»¤ä½¿ç”¨çš„redisçš„å‘½ä»¤æ˜¯delï¼Œè¿™ç§åˆ é™¤æ–¹å¼å¦‚æœåˆ é™¤å¤§æ‰¹é‡çš„å€¼ä¼šå­˜åœ¨é˜»å¡é—®é¢˜ï¼Œå› æ­¤ç”Ÿäº§ç¯å¢ƒæ˜¯ä¸æ¨èä½¿ç”¨çš„ï¼›å¹¶ä¸”æˆ‘æ‰§è¡Œä¸Šé¢å‘½ä»¤æ²¡æœ‰æˆåŠŸï¼Œæç¤ºdelç¼ºå°‘å‚æ•°ã€‚å› æ­¤ä¸Šè¿°å‘½ä»¤åªæ˜¯ä½œä¸ºè®°å½•å’Œå‚è€ƒã€‚

#### ä¸‰.ä½¿ç”¨Redisçš„EVALæ‰§è¡ŒLuaè„šæœ¬æ–¹å¼

> redis 2.6.0 ä¹‹åçš„ç‰ˆæœ¬æ”¯æŒé€šè¿‡ [EVAL](https://redis.io/commands/eval) æˆ– [EVALSHA](https://redis.io/commands/evalsha) æ‰§è¡Œä½¿ç”¨Luaã€‚ å¯ä»¥ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¿˜å¯ä»¥é€šè¿‡  `script load` å¯¹è„šæœ¬è¿›è¡Œç¼“å­˜ï¼Œå‡å°‘ç½‘ç»œå¼€é”€ã€‚ä½¿ç”¨lua æœ‰æ›´é«˜çš„è‡ªç”±åº¦ï¼Œå¯ä»¥æ·»åŠ å¾ˆå¤šåŠŸèƒ½æ¨¡å—ã€‚
>
> redis2.8.0ä¹‹åä½¿ç”¨SCANæ›¿ä»£KEYSï¼Œå¯¹å¤§æ‰¹é‡çš„æŸ¥è¯¢è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä¸ä¼šé˜»å¡ä¸»è¿›ç¨‹
>
> å¹¶ä¸”æ–°ç‰ˆæœ¬ï¼ˆ4.0.0ä¹‹åï¼‰çš„redisä½¿ç”¨UNLINKä»£æ›¿DELå‘½ä»¤ã€‚UNLINKä¼šåœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œå†…å­˜çš„å›æ”¶ï¼Œä¸ä¼šé˜»å¡æ­£å¸¸çš„get setè¯·æ±‚ã€‚
>
> ä¹Ÿå°±æ˜¯æœ¬æ–‡é‡‡ç”¨çš„æŸ¥è¯¢å’Œåˆ é™¤æ–¹å¼ã€‚

luaçš„æ–‡ä»¶å¦‚ä¸‹ï¼š

```lua
-- é€‰æ‹©è¦æ“ä½œçš„æ•°æ®åº“
redis.call("select",7)
--æ¸¸æ ‡çš„id
local cursor = 0
--æŸ¥æ‰¾åˆ é™¤çš„keyçš„æ•°é‡
local keyNum = 0
repeat
  --ä½¿ç”¨scanæœç´¢ï¼Œcursor=0çš„æ—¶å€™æ ‡è¯†ä¸€ä¸ªæ–°çš„è¿­ä»£æœŸ,æœåŠ¡å™¨è¿”å›0çš„æ—¶å€™è¡¨ç¤ºè¿­ä»£å·²ç»ç»“æŸ
  local res = redis.call("scan",cursor,"MATCH",KEYS[1])
  if(res ~= nil and #res>=0) then
    cursor = tonumber(res[1])
    local ks = res[2]
    if(ks ~= nil and #ks>0) then
      redis.replicate_commands()
      --å¾ªç¯åˆ é™¤å½“å‰è¿­ä»£å™¨è¿­ä»£å‡ºçš„æ•°æ®
      for i=1,#ks,1 do
        local key = tostring(ks[i])
        --ä½¿ç”¨UNLINKåˆ é™¤ï¼ŒåŒºåˆ«äºdelçš„æ˜¯è¿™ä¸ªæ˜¯å¼‚æ­¥æ‰§è¡Œçš„
        --è¿™æ¡æŒ‡ä»¤è¦ç‰ˆæœ¬å¤§äº4.0.0 å°äº4.0.0å°±ä½¿ç”¨del
        redis.call("UNLINK",key)
      end
      --ç»Ÿè®¡åˆ é™¤çš„keyçš„æ•°é‡
      keyNum = keyNum + #ks
    end
  end
--å½“æœåŠ¡å™¨è¿”å›0çš„æ—¶å€™ï¼Œè·³å‡ºå¾ªç¯
until( cursor <= 0 )

return keyNum
```

é€šè¿‡redis-cliæ‰§è¡Œè„šæœ¬

```shell
# é€šè¿‡redis-cliæ‰§è¡Œè„šæœ¬
redis-cli -h åœ°å€ -p ç«¯å£ -a å¯†ç  --eval ä»¥ä¸Šåˆ›å»ºæ–‡ä»¶çš„è·¯å¾„/clear_data.lua "éœ€è¦åˆ é™¤çš„keyçš„å‰ç¼€_*"
# å¤šå€¼ä¼ é€ç¤ºä¾‹
redis-cli -h åœ°å€ -p ç«¯å£ -a å¯†ç  --eval ä»¥ä¸Šåˆ›å»ºæ–‡ä»¶çš„è·¯å¾„/clear_data.lua "key1" "key2" , "va1" "va2"
# è„šæœ¬è°ƒç”¨ç¤ºä¾‹
redis-cli -h 127.0.0.1 -p 6379 -a 123456789 --eval /usr/local/redis/clear_data.lua "test_*"
```

å‚è€ƒæ–‡ç« ï¼š

[Redis EVALæ‰§è¡ŒLuaè„šæœ¬ä¹‹æ‰¹é‡åˆ é™¤æ•°æ®](https://blog.csdn.net/lupengfei1009/article/details/86619160)

[æˆ‘æƒ³æ¨¡ç³Šåˆ é™¤ redis keyğŸ¤”](https://xie.infoq.cn/article/0e34856ec9a88d749e7b1ae7a)