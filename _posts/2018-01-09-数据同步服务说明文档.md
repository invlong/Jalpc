---
layout: post
title:  "HelloWorld"
date:   2017-03-15
desc: "My first blog by jekyll"
keywords: "Jekyll,gh-pages,website,blog"
categories: [Life]
tags: [Jekyll]
icon: icon-html
---

一.功能概览
--
__1.数据初始化__  
项目启动时，可以对已配置的多个表进行数据同步，即同步目标表所有的数据到待同步表，同时支持对目标表不完全字段的同步（只关心业务字段）。   
需要注意：初始化时会对目标表进行锁表操作，直至同步完成。  
__2.数据同步__  
当已配置的目标表，目标字段的数据发生改变时，程序会感应到变化，并同步改变到待同步数据库。  
__3.提供数据监听注册接口__  
用户可以根据RESTFul风格的接口，注册对表-字段的监听，当数据发生变化时，程序会推送相关改变信息。  
用户请求开通接口后，会返回rabbitmq的queue,exchange,routing信息，用户根据这三个信息自己去rabbitmq建立订阅。  
__4.注销监听__  
通过调用RESTFul接口，取消对目标表/字段的监听。  
__5.推送数据变更信息给注册者__  
数据同步完成之后，对数据监听注册者进行通知，携带数据信息。  
二.项目配置  
--
__1.application.properties配置文件说明__  

主要包含四大部分：  
①数据初始化连接信息  
在这里包含数据初始化的数据库信息，并且指定了数据同步的数据库类型。  
②数据同步连接信息  
数据同步连接信息单独配置，请注意与初始化配置信息区别开来，但除了Oracle以为，其他的数据库连接信息与初始化连接信息是一样的，少了几个变量而已。  
mysql没有这个配置，因为mysql是rabbitmq主动推送变更信息给程序，不需要配置。  
③rabbitmq配置信息  
这里的配置信息包含向注册者发送消息的rabbitmq的配置，以及当数据同步类型为mysql时的rabbitmq配置。  
④待同步数据库连接信息  
这里的待同步数据库为pg数据库  

__rabbotmq的配置__  
```
# ip地址
spring.rabbitmq.host=10.0.0.96
# 端口号
spring.rabbitmq.port=5679
# mysql 配置订阅用的queue名称
spring.rabbitmq.queue-name=ss
# queue是否重复可用
spring.rabbitmq.queue-durable=1
# exchange 是否重复可用
spring.rabbitmq.exchange-durable=0
# mysql 配置订阅用的 exchange 名称
spring.rabbitmq.exchange=maxwell
# 用户名
spring.rabbitmq.username=guest
# 密码
spring.rabbitmq.password=guest
# 发送rabbitmq用的exchange名  
spring.rabbitmq.sub-exchange=synserver
# 发送rabbitmq用的queue名
spring.rabbitmq.sub-queue=synserver_dcn_queue
# 如果开启的是mysql监听，这里要写上mysql的数据库名，否则可以为空。 
spring.rabbitmq.database=testduliyan
```
__postgresql配置__  
```
# 地址
app.datasource.pg.url=jdbc:postgresql://10.0.0.96:5432/orcl_dcn
# 用户名
app.datasource.pg.username=postgres
# 密码
app.datasource.pg.password=123456
# 最大连接数
app.datasource.pg.max-total=30
# 驱动包
app.datasource.pg.driverClassName=org.postgresql.Driver
```
__oracle数据库配置__  
这里指的是开启监听后生成的schema相关信息，即获取改变的数据的连接地址。  
```
# 地址
app.datasource.oracle.url=jdbc:oracle:thin:@10.2.0.16:1521:orcl
app.datasource.oracle.username=cdc_publisher
app.datasource.oracle.password=cdc_publisher
app.datasource.oracle.max-total=30
app.datasource.oracle.driverClassName=oracle.jdbc.driver.OracleDriver
```
__sql server数据库配置__  
```
app.datasource.sql-server.url=jdbc:sqlserver://10.2.0.60\\MSSQLSERVER:1433;database=CDC_DB
app.datasource.sql-server.username=sa
app.datasource.sql-server.password=123456
app.datasource.sql-server.max-total=30
app.datasource.sql-server.driverClassName=com.microsoft.sqlserver.jdbc.SQLServerDriver
```
__数据初始化时的数据库连接信息__  
下面三个配置中选择一个，db-type = 1 为Oracle，db-type = 2 为sql server ,db-type =3 为mysql  
根据这个字段程序会判断是对哪个数据库的监听。  
`core-init为是否要初始化同步数据。`  
```
# sql server 数据库
spring.db.core.core-init=0
spring.db.core.core-db-type=2
spring.db.core.core-thread-num=5
spring.db.core.username=sa
spring.db.core.password=123456
spring.db.core.url=jdbc:sqlserver://10.2.0.60\\MSSQLSERVER:1433;database=CDC_DB
spring.db.core.driverClassName=com.microsoft.sqlserver.jdbc.SQLServerDriver

# Oracle 数据库
spring.db.core.core-init=0
spring.db.core.core-db-type=1
spring.db.core.core-thread-num=5
spring.db.core.username=cdc_publisher
spring.db.core.password=cdc_publisher
spring.db.core.url=jdbc:oracle:thin:@10.2.0.16:1521:orcl
spring.db.core.driverClassName=oracle.jdbc.driver.OracleDriver

# mysql数据库
spring.db.core.core-init=0
spring.db.core.core-db-type=3
spring.db.core.core-thread-num=5
spring.db.core.username=root
spring.db.core.password=123456
spring.db.core.url=jdbc:mysql://10.0.0.96:3123/testduliyan
spring.db.core.driverClassName=com.mysql.jdbc.Driver
```
__同步数据周期__  
如果为Oracle或者sql server，需要设置多久进行一次数据同步感知，单位为毫秒。  
```
spring.shedule.fixed-rate=30000
```
__2.配置表说明__  
1.cdc配置表  
配置要监听的核心表(客户数据库)及字段，目标表(我们的数据库)及字段。  
id-主键  
core_user-核心表所在的数据库及schema名  
core_table-核心表名  
core_column-核心表字段  
core_column_type-核心表字段类型(oracle数据库时需要指定)  
target_table-目标表名
target_column-目标表字段  
sys_flag-系统标识，固定。  
seq-字段顺序。请严格按照实际表的对应顺序，从1,2,3开始。

```sql
create table cdc_config
(
	id integer not null
		constraint cdc_config_pkey
			primary key,
	core_user varchar(32),
	core_table varchar(32),
	core_column varchar(32),
	target_table varchar(32),
	target_column varchar(32),
	sys_flag varchar(32),
	core_column_type varchar(32),
	seq integer
);

-- 创建注册表，执行下列sql语句即可，不需要其他操作。  
create table cdc_register
(
	id serial not null
		constraint cdc_register_pkey
			primary key,
	routing_key varchar(32),
	table_name varchar(32),
	column_name varchar(32),
	operation varchar(32),
	is_detail boolean default false,
	create_time timestamp default now(),
	is_full_table boolean default false
);
create unique index cdc_register_id_uindex
	on cdc_register (id);
comment on column cdc_register.operation is 'insert,update,,delete/all';
comment on column cdc_register.is_detail is '是否需要更改的详细信息';
comment on column cdc_register.create_time is '创建时间';
comment on column cdc_register.is_full_table is '是否监听表的所有字段';


```
`配置完以上所有后，启动服务，即可开启数据同步服务`  
三.注册/注销监听  
--
经过以上配置，数据同步服务已经开通，但本程序同时对关心数据变更的用户提供通知服务，但需要注册/注销。  
__1.注册服务__  
仅支持post请求。  
接口地址：http://localhost:8080/api/register.do  
请求参数：  
`必须使用数组进行传输`    
tableName （表名）  
columnName （字段名）  
operation （操作类型：insert,update,delete,all）  
isDetail （是否需要操作的详细信息） 
fullTable  (是否监听所有的字段，如果为true,那么columnName字段可以为空)  
返回参数：  
result  (是否成功标识，1为成功，其他为失败)   
msg （返回描述）  
data （返回的数据：包含exchange,routing,queue）  
__2.注销服务__  
仅支持post请求。  
接口地址：http://localhost:8080/api/unRegister.do  
请求参数：  
`必须使用数组进行传输`   
routingKey  (标识要注销的key)  
isFullTable  (是否删除对所有字段的监听)  
tableName  （要注销的表名）  
columnName  （要注销的字段名，如果isFullTable是true，该字段可以不传）  
返回参数：  
result  (是否成功标识，1为成功，其他为失败)   
msg （返回描述）  
